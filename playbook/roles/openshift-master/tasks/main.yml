- name: create openshift-master config directory
  file:
    path: /var/lib/origin/openshift.local.config/master
    state: directory

- name: install ca root certificate set
  copy:
    src: "{{ item.file }}"
    dest: /var/lib/origin/openshift.local.config/master/{{ item.file }}
    mode: "{{ item.mode }}"
    force: "{{ item.force | default(true) }}"
  with_items:
    - file: ca.crt
      mode: '0644'
    - file: ca.key
      mode: '0600'
    - file: ca.serial.txt
      mode: '0644'
      force: false

- name: create the master certificates
  command: >
    {{ openshift_admin_binary }} ca create-master-certs
      --hostnames={{ private_ip }},openshift-master.skydns.local
      --master=https://{{ private_ip }}:8443
      --public-master=https://{{ private_ip }}:8443
      --cert-dir=/var/lib/origin/openshift.local.config/master
  args:
    creates: /var/lib/origin/openshift.local.config/master/master.server.crt

- name: create the policy file
  command: {{ openshift_admin_binary }} create-bootstrap-policy-file
  args:
    creates: /var/lib/origin/openshift.local.config/master/policy.json

- name: symlink the admin kubeconfig to /root/.kube/config
  file:
    src: /var/lib/origin/openshift.local.config/master/admin.kubeconfig
    dest: /root/.kube/config
    state: link

- name: install openshift-master config
  template:
    src: master-config.yaml
    dest: /var/lib/origin/openshift.local.config/master/master-config.yaml
  notify: restart openshift-master

- name: install openshift-master service
  template:
    src: openshift-master.service
    dest: /etc/systemd/system/openshift-master.service
  notify: restart openshift-master
  register: openshift_master_service

- name: reload service files
  command: systemctl daemon-reload
  when: openshift_master_service.changed

- name: start and enable openshift-master
  service: name=openshift-master state=started enabled=yes
  register: start_result

- set_fact:
    openshift_master_service_status_changed: "{{ start_result | changed }}"
